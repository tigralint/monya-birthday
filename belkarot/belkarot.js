document.addEventListener('DOMContentLoaded', () => {

    // Функция, которая запускает "квест"
    function requestQuarantineCode() {
        
        // 1. Показываем всплывающее окно
        const code = prompt(
            "[ВНИМАНИЕ! ОБНАРУЖЕНО НЕСАНКЦИОНИРОВАННОЕ ПРОНИКНОВЕНИЕ.]\n\n" +
            "СИСТЕМА НЕСТАБИЛЬНА. АФФЕКТИВНЫЙ РЕЗОНАНС 'БЕЛКАРОТ' ДОСТИГ КРИТИЧЕСКОГО УРОВНЯ.\n\n" +
            "ТРЕБУЕТСЯ НЕМЕДЛЕННАЯ СТАБИЛИЗАЦИЯ.\n\n" +
            "ВВЕДИТЕ ПРОТОКОЛ СДЕРЖИВАНИЯ (4 ЦИФРЫ):", 
            "..."
        );

        // 2. Проверяем, что ввела София
        if (code === null) {
            
            // --- НАЧАЛО ИЗМЕНЕНИЙ ---
            // Пользователь нажал "Отмена". ЭТО НЕ ОПЦИЯ.
            // Принудительно запрашиваем код снова.
            alert(
                "[ОШИБКА! ЗАПРОС НА СТАБИЛИЗАЦИЮ ОТКЛОНЕН!]\n\n" +
                "Отказ от ввода протокола недопустим. Система впадает в неконтролируемый резонанс...\n\n" +
                "ПОВТОРНЫЙ ЗАПРОС ПРОТОКОЛА СДЕРЖИВАНИЯ."
            );
            requestQuarantineCode(); // Запускаем функцию снова
            // --- КОНЕЦ ИЗМЕНЕНИЙ ---

        } else if (code.trim() === '1488') {
            // УСПЕХ! Пароль верный.
            // 3. Добавляем класс "stabilized" к <body>
            document.body.classList.add('stabilized');
            
            // Меняем заголовок на "стабильный"
            const header = document.getElementById('main-glitch-header');
            header.innerText = "ПРОТОКОЛ 1488 ПРИНЯТ. СИСТЕМА СТАБИЛИЗИРОВАНА.";
            // Очищаем data-text, чтобы псевдо-элементы тоже исчезли
            header.dataset.text = "ПРОТОКОЛ 1488 ПРИНЯТ. СИСТЕМА СТАБИЛИЗИРОВАНА.";

            // 4. Находим и выключаем жуткий эмбиент
            const horrorAudio = document.getElementById('horror-audio');
            if (horrorAudio) {
                horrorAudio.pause();
                horrorAudio.currentTime = 0;
            }

        } else {
            // ПРОВАЛ! Пароль неверный.
            // 4. Показываем ошибку и запускаем квест заново (рекурсия)
            alert(
                "[ОШИБКА ДОСТУПА! НЕВЕРНЫЙ ПРОТОКОЛ!]\n\n" +
                "Аффективный резонанс 'Белкарот' усиливается...\n\n" +
                "Повторите ввод."
            );
            requestQuarantineCode(); // Запускаем функцию снова
        }
    }

    // 5. Запускаем квест, как только страница загрузилась.
    requestQuarantineCode();

});